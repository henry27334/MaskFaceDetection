# 口罩臉部偵測模型

## 目錄
- [研究主題](#研究主題)
- [研究動機](#研究動機)
- [模型設計與實作](#模型設計與實作)


## 研究主題

疫情持續至今，相應的防疫規範也因應而生，穿戴口罩已是對人民的基本要求。對於未遵守規定穿戴口罩的民眾，需要花費額外的精力監察民眾穿戴口罩，相信無論是政府亦或是民間企業皆為此感到頭痛。倘若能不透過人為的方式監測民眾口罩穿戴的狀況，肯定能省下不少精力。因此學生以這個方向作為思考，學習編寫了口罩臉部偵測模型。

## 研究動機 

疫情持續至今，相應的防疫規範也因應而生，穿戴口罩已是對人民的基本要求。對於未遵守規定穿戴口罩的民眾，需要花費額外的精力監察民眾穿戴口罩，相信無論是政府亦或是民間企業皆為此感到頭痛。倘若能不透過人為的方式監測民眾口罩穿戴的狀況，肯定能省下不少精力。因此學生以這個方向作為思考，學習編寫了口罩臉部偵測模型。

## 模型設計與實作

(一)資料前處理
使用ImageDataGenerator進行圖像預處理。
flow_from_dataframe函數的作用是將數據框與圖像所在目錄生成批量的增強/標準化數據。參數設定class_mode為”binary”意即1D的二進制標籤(有/無戴口罩)，所以需要提供y_col作為目標數據的行。x_col為數據框包含文件名稱的行。每次batch的數量設定為80，不打亂數據，最終目標調整的維度大小維(150,150)。(如圖1-1)

![image](https://user-images.githubusercontent.com/75149212/139945690-9d833ea3-aa31-4f6c-8fcd-2c3142c88f12.png)

###### 圖1-1  資料前處理圖

(二)模型架構
口罩偵測的部分使用VGG19模型。VGG系列模型是英國牛津大學Visual Geometry Group的縮寫。主要貢獻是使用更多的隱藏層並進行大量的圖片訓練，將準確率提高至90%。VGG16及VGG19的主要差別在於分別為16層，其中為13層卷積層與19層其中為16個卷積層及3個全連接層。
VGG模型系列使用了ImageNet大約一百萬張圖片，共一千種類別的資料集訓練出來的模型。若需要的辨識內容不在這一千類之中，也可以替換掉input的卷基層，利用中間萃取的特徵，這種能力被稱為「Transfer Learning」。Transfer Learning 遷移學習的作用主要是允許使用者將知識從其中一個模組遷移至另一個模組之中。實作遷移學習涉及使用更多數據重新訓練用於類似應用程式的網路最後幾層。這個想法是網路中較早的隱藏單元具有更廣泛的應用方面，通常不特定於您使用網路的確切任務。總而言之，當兩種任務擁有相同的輸入特徵，並且嘗試學習的任務數據比嘗試訓練的任務還多的時候，遷移訓練才能有效果。
VGG19的模型結構如圖1-2，圖像作為卷積層的輸入傳進去，將convolution layer 所產生的3x3 feature maps進行Max Pooling(也就是二次抽樣 Subsampleing)，進行降維，此步驟目的是降低雜訊且減少參數為目標，可提升CNN整體效能及降低運算量。反覆進行後處理完卷積層後才會將其輸出傳送給全連接層作為輸入。
 
![image](https://user-images.githubusercontent.com/75149212/139945776-5893c9c8-e6a9-414a-af1e-04cdcf97594a.png)

###### 圖1-2  VGG19模型架構圖

由於VGG19模型已經將結構寫好了。所以我們呼叫時只需要一行指令，就可以將權重載入程式之中。個別參數的設定為Weights: imagenet便是使用預先訓練好的資料集，約一百萬張圖片，判斷一千類別的事物(像是動物、交通工具等等)。include_top = False: 只利用VGG19萃取特徵，後面的分類處理由使用者設計。所以此模型不包含後三層，再自接三個完全連接層。(如圖1-3)

![image](https://user-images.githubusercontent.com/75149212/139945895-2bbec988-48e5-4464-a15c-cfafe22af648.png)

![image](https://user-images.githubusercontent.com/75149212/139945901-9b426fa1-ac5f-4221-b65e-3a0d3ec6cfce.png)
![image](https://user-images.githubusercontent.com/75149212/139945916-6d84e1f4-4429-4128-92ef-1cf3003ce4e4.png)

圖1-3  模型架構創建圖

就像如圖1-4參數的設定，不直接使用VGG19的後續分類處理，而是自行設計全連接層。

![image](https://user-images.githubusercontent.com/75149212/139945947-9fb604f4-c2ff-402a-a1d7-1c7364ee3fee.png)

###### 圖1-4  完全連接層設計圖
  
Flatten將model的output扁平化，把多維輸入壓扁維一維輸出，常用於從卷積層到全連接層的過度，無參數。
使用ReLu函數(Rectified Linear Unit)，整流線性單元。根據z值來確定neuron的輸出。假設z值為正值，ReLU使用此數值當作neuron的輸出，反之輸出則為零。ReLU的輸出範圍位於0至+∞ 之間。ReLU activation function的好處在於能夠有效計算及允許網路快速收斂。
Sigmoid activation function 使用S型函數計算neuron輸出，S型函數產生的值將會落於0到1之間，當輸入值大小有所差異時，將使得輸出平滑化，而不會出現數值差異過大的狀況。
臉部偵測模型CascadeClassifier，是Opencv中做人臉偵測的時候的一個分類器。並且可以使用Haar特徵。Haar特徵是一種反應圖像灰階變化，像素分模塊求差值的一種特徵。例如：臉部的一些特徵能由矩形模塊差值特徵簡單的描述，如：眼睛要比臉頰顏色要深，鼻樑兩側比鼻樑顏色要深，嘴巴比周圍顏色要深等。Haar特徵分類器就是一個XML文件，該文件會描述人體各個部位的Haar特徵值。包括人臉、眼睛、嘴唇等等。detectMultiScale函數能檢測出圖片中所有的人臉，並將人臉用vector保存各個人臉的座標、大小(以矩陣表示)。(如圖1-5)

![image](https://user-images.githubusercontent.com/75149212/139945987-76a0b7a8-e4a7-43e9-a1af-5ff72147ecad.png)
 
###### 圖1-5  臉部偵測模型圖

(三)訓練過程

模型編譯：優化器使用adam，Adam優化算法是隨機梯度下降算法的擴展式，可以替代傳統隨機梯度下降過程的一階優化算法，能基於訓練數據疊代地更新神經網路，該方法相當容易實現，計算效率高，內存要求低。損失函數使用binary crossentropy方法，一般用於二元分類，針對概率之間的損失函數。metrics衡量指標使用準確度作為矩陣標準。
再來就是fit的部分，Epochs次數為10次，所有訓練資料跑過模型的次數。steps_per_epoch次數為訓練資料集取整除，它的用途是讓模型能夠確定每次epoch的起始及結束點。
這裡設定是依照train_generator的數量大小除以80作為每次epoch的次數。validation_steps指定訓練幾次後 要用多少資料驗證一次(通常不調整)，配合batch權重修正後才驗證一次，設定是依照valid_generator的數量大小除以80作為每次epoch的次數。Callbacks使用上面設定好方法，每次訓練資料跑過後，儲存最好的權重值。(如圖1-6)

![image](https://user-images.githubusercontent.com/75149212/139946038-efa3c66a-7cde-4443-9053-f5e66fae5564.png)

![image](https://user-images.githubusercontent.com/75149212/139946046-3a5108e2-d32c-488a-874a-9ee5a1cbe88a.png)

###### 圖1-6  模型訓練過程圖

(四)成果展示

由圖1-7之折線圖可以看出每次訓練後得到的準確值與損失值，準確度在訓練集與測試集最高能達到100%準確度; 損失值也在多次epochs後慢慢逐步下降。
 
![image](https://user-images.githubusercontent.com/75149212/139946093-37b913b0-eb2d-43ef-88c5-aab5647388f4.png)

###### 圖1-7  訓練結果折線圖

(五)預測結果

綠色框格代表有適當穿戴口罩，紅色框格代表沒有穿戴口罩。由圖像可看出模型準確標記出口罩穿戴情況，無論是單人或多人皆能準確偵測。(如圖1-8、圖1-9)

![image](https://user-images.githubusercontent.com/75149212/139946148-237d654c-ec46-4efd-84cf-049e97d6f331.png)

###### 圖1-8  穿戴口罩預測圖—單人
 
![image](https://user-images.githubusercontent.com/75149212/139946172-a845adcb-5ad0-4485-8f2b-9bdb2dd304f2.png)

###### 圖1-9  穿戴口罩預測圖—多人
